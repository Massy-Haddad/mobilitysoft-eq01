name: CI-CD MobilitySoft

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  tests:
    name: Run tests (mobilitysoft)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

      - name: Run pytest
        run: |
          pytest || true

  build-and-push:
    name: Build & Push MobilitySoft image
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build MobilitySoft image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/mobilitysoft-eq01:${{ github.sha }} .

      - name: Push MobilitySoft image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/mobilitysoft-eq01:${{ github.sha }}


  deploy:
    name: Deploy MobilitySoft to GKE
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Auth GCP avec ton service account JSON (GCP_SA_KEY)
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2) Récupérer les credentials GKE → configure kubectl automatiquement
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 3) Namespace
      - name: Ensure namespace exists
        run: |
          kubectl get ns grp01eq1-namespace || kubectl create ns grp01eq1-namespace

      # 4) Secret DB (même que Metrics)
      - name: Create / update db-credentials secret
        run: |
          kubectl create secret generic db-credentials \
            --from-literal=POSTGRES_HOST=${{ secrets.DB_HOST }} \
            --from-literal=POSTGRES_DB=${{ secrets.DB_NAME }} \
            --from-literal=POSTGRES_USER=${{ secrets.DB_USER }} \
            --from-literal=POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --from-literal=DATABASE_URL="postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5432/${{ secrets.DB_NAME }}" \
            -n grp01eq1-namespace \
            --dry-run=client -o yaml | kubectl apply -f -

      # 5) Injecter la bonne image pour MobilitySoft
      - name: Inject image tag in mobilitysoft-deployment.yaml
        run: |
          sed -i "s|DOCKER_USERNAME/mobilitysoft-eq01:IMAGE_TAG_MOBILITY|${{ secrets.DOCKER_USERNAME }}/mobilitysoft-eq01:${{ github.sha }}|g" k8s/mobilitysoft-deployment.yaml

      # 6) Appliquer les manifests
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/ -n grp01eq1-namespace

      # 7) Vérifier le rollout
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/mobilitysoft -n grp01eq1-namespace
