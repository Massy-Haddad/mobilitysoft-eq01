# Exemple d'utilisation du script send_metrics.py dans le workflow ci-cd.yml
#
# Ajoutez ces √©tapes dans le job "metrics" apr√®s la collecte des r√©sultats

# Job 3: Envoi des m√©triques CI (avec vraie int√©gration)
metrics:
  name: Envoi des m√©triques CI
  needs: [tests, docker]
  runs-on: ubuntu-latest
  if: always() && github.event_name == 'push'
  
  steps:
  - name: Checkout du code
    uses: actions/checkout@v4

  - name: Configuration de Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.11'

  - name: Installation de requests
    run: pip install requests

  - name: Pr√©paration des m√©triques
    id: prepare
    run: |
      # Extraire les r√©sultats des tests (exemple simplifi√©)
      # En production, vous devriez parser les vrais r√©sultats
      echo "TEST_RESULTS={\"total\":25,\"passed\":25,\"failed\":0,\"skipped\":0,\"duration\":45,\"coverage\":85,\"pylint_score\":9.5,\"black_formatted\":true,\"pre_commit_passed\":true}" >> $GITHUB_ENV
      
      # Extraire les r√©sultats du build
      # Tags cr√©√©s par le job docker
      TAGS=$(echo '${{ needs.docker.outputs.tags }}' | jq -R 'split(",")' || echo '["latest"]')
      BUILD_SUCCESS=$([[ "${{ needs.docker.result }}" == "success" ]] && echo "true" || echo "false")
      
      echo "BUILD_RESULTS={\"success\":${BUILD_SUCCESS},\"duration\":120,\"image_size_mb\":450,\"tags\":${TAGS},\"dockerhub_push\":true,\"push_duration\":30}" >> $GITHUB_ENV
      
      # Message du commit
      echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_ENV

  - name: Envoi vers l'application Metrics
    env:
      METRICS_API_URL: ${{ secrets.METRICS_API_URL }}
      METRICS_API_KEY: ${{ secrets.METRICS_API_KEY }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_REF_NAME: ${{ github.ref_name }}
      GITHUB_SHA: ${{ github.sha }}
      GITHUB_ACTOR: ${{ github.actor }}
    run: |
      python .github/scripts/send_metrics.py

  - name: R√©sum√© des m√©triques
    if: always()
    run: |
      echo "## üìä R√©sum√© des m√©triques CI/CD" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### Tests" >> $GITHUB_STEP_SUMMARY
      echo "- ‚úÖ Statut: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
      echo "- üß™ Tests: 25 total" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### Build Docker" >> $GITHUB_STEP_SUMMARY
      echo "- ‚úÖ Statut: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
      echo "- üêã Image pouss√©e sur DockerHub" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### üìà M√©triques envoy√©es √† l'application Metrics" >> $GITHUB_STEP_SUMMARY


# ALTERNATIVE SIMPLE : Envoi direct avec curl (sans script Python)
#
# - name: Envoi vers l'application Metrics (version simple)
#   if: success()
#   run: |
#     curl -X POST ${{ secrets.METRICS_API_URL }} \
#       -H "Content-Type: application/json" \
#       -H "Authorization: Bearer ${{ secrets.METRICS_API_KEY }}" \
#       -d '{
#         "project": "mobilitysoft",
#         "branch": "${{ github.ref_name }}",
#         "commit_sha": "${{ github.sha }}",
#         "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
#         "metrics": {
#           "tests": {
#             "total": 25,
#             "passed": 25,
#             "failed": 0,
#             "duration_seconds": 45
#           },
#           "build": {
#             "success": true,
#             "duration_seconds": 120
#           }
#         }
#       }' || echo "√âchec de l'envoi des m√©triques (non bloquant)"
