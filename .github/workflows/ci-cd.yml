name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, "CI/CD" ]
  pull_request:
    branches: [ main, master, develop ]

env:
  DOCKER_IMAGE_NAME: mobilitysoft

jobs:
  # √âtape 1: Tests d'int√©gration
  test:
    name: test d'int√©gration
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mobilitysoft_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Configuration de Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Installation des d√©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Ex√©cution des tests d'int√©gration
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/mobilitysoft_test_db
        LOG_LEVEL: DEBUG
      run: |
        pytest tests/test_consultation_api.py tests/test_predictions.py -v --tb=short

  # √âtape 2: Build de l'image Docker
  build:
    name: build
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Configuration de Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build de l'image Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:build-${{ github.run_number }}
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/image.tar

    - name: Upload de l'artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: /tmp/image.tar
        retention-days: 1

  # √âtape 3: Push vers DockerHub
  push:
    name: push
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Download de l'artifact
      uses: actions/download-artifact@v3
      with:
        name: docker-image
        path: /tmp

    - name: Configuration de Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Connexion √† DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Chargement de l'image Docker
      run: docker load --input /tmp/image.tar

    - name: Push de l'image vers DockerHub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:build-${{ github.run_number }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

    - name: R√©sum√© du d√©ploiement
      run: |
        echo "‚úÖ Image Docker pouss√©e avec succ√®s sur DockerHub!"
        echo "ÔøΩ Tags disponibles:"
        echo "  - latest"
        echo "  - build-${{ github.run_number }}"
        echo "  - ${{ github.sha }}"
        echo "üîó DockerHub: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}"
